# .github/workflows/pull-request-approve.yml
# Workflow to be triggered on PR approval, receives target_branch as input, checks out the repo,
# computes the correct opencga-enterprise branch, and calls test-xetabase with the calculated branch and PR head as task.

name: Xetabase PR Approve Entrypoint

on:
  workflow_call:
    inputs:
      target_branch:
        description: 'Target branch of the PR (github.event.pull_request.base.ref)'
        required: true
        type: string
      head_ref:
        description: 'Source branch of the PR (github.event.pull_request.head.ref)'
        required: true
        type: string
    secrets:
      ZETTA_REPO_ACCESS_TOKEN:
        required: true
      THIRDPARTY_READ_TOKEN:
        required: false
      KEEPER_SM_GH_OPENCB:
        required: false

jobs:
  resolve-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout triggering repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 10
          path: triggering-repo
      - name: Parse pom.xml to get project artifactId
        id: pom
        shell: bash
        working-directory: triggering-repo
        run: |
          artifactId=$(xmllint --xpath '/*[local-name()="project"]/*[local-name()="artifactId"]/text()' pom.xml)
          echo "artifactId=$artifactId" >> "$GITHUB_OUTPUT"
      - name: Compute opencga-enterprise branch
        id: compute_branch
        env:
          ZETTA_REPO_ACCESS_TOKEN: ${{ secrets.ZETTA_REPO_ACCESS_TOKEN }}
        shell: bash
        working-directory: triggering-repo
        run: |
          chmod +x ../.github/workflows/scripts/get_opencga_enterprise_branch.sh
          branch=$( ../.github/workflows/scripts/get_opencga_enterprise_branch.sh "${{ steps.pom.outputs.artifactId }}" "${{ inputs.target_branch }}" "${{ inputs.head_ref }}" )
          echo "branch=$branch" | tee -a $GITHUB_STEP_SUMMARY
          echo "branch=$branch" >> $GITHUB_OUTPUT
      - name: Checkout opencga-enterprise
        uses: actions/checkout@v4
        with:
          repository: zetta-genomics/opencga-enterprise
          ref: ${{ steps.compute_branch.outputs.branch }}
          path: opencga-enterprise
          token: ${{ secrets.ZETTA_REPO_ACCESS_TOKEN }}
      - name: Call test-xetabase workflow with calculated branch
        uses: ./.github/workflows/test-xetabase.yml
        with:
          branch: ${{ steps.compute_branch.outputs.branch }}
          task: ${{ inputs.head_ref }}
        secrets:
          ZETTA_REPO_ACCESS_TOKEN: ${{ secrets.ZETTA_REPO_ACCESS_TOKEN }}
          THIRDPARTY_READ_TOKEN: ${{ secrets.THIRDPARTY_READ_TOKEN }}
          KEEPER_SM_GH_OPENCB: ${{ secrets.KEEPER_SM_GH_OPENCB }}
