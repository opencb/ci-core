name: Reusable workflow to build Java application

on:
  workflow_call:
    inputs:
      maven_opts:
        type: string
        required: false
      build_folder:
        type: string
        required: false
        default: "build-folder"
      upload_artifact:
        type: boolean
        required: false
        default: false
      java_version:
        type: string
        required: false
        default: "11"
      storage_hadoop:
        type: string
        required: false
        default: "hdi5.1"
      dependency_repos:
        type: string
        required: false
        default: ""
      needs_hadoop_preparation:
        type: boolean
        description: "If true, prepare Hadoop environment after setting up Java and Maven cache"
        required: false
        default: false
      deploy_maven:
        type: boolean
        description: "If true, deploy to Maven repository after building"
        required: false
        default: false
    secrets:
      MAVEN_GPG_PASSPHRASE:
        required: false
      MAVEN_GPG_PRIVATE_KEY:
        required: false
      MAVEN_USER_TOKEN:
        required: false
      MAVEN_PASSWORD_TOKEN:
        required: false
      THIRDPARTY_READ_TOKEN:
        required: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        # This step checks out the current repository source code
        uses: actions/checkout@v4

      - name: Setup Java, dependencies and Maven cache
        # Este paso ahora configura Java para build o deploy segÃºn inputs.deploy_maven
        id: setup_java_maven
        uses: opencb/ci-core/.github/actions/setup-java-maven@main
        with:
          java_version: ${{ inputs.java_version }}
          storage_hadoop: ${{ inputs.hadoop_flavour || vars.HADOOP_FLAVOUR }}
          dependency_repos: ${{ inputs.dependency_repos }}
          needs_hadoop_preparation: ${{ inputs.needs_hadoop_preparation }}
          deploy_maven: ${{ inputs.deploy_maven }}
          server-id: ossrh                                        # Value of the distributionManagement/repository/id field of the pom.xml
          server-username: MAVEN_NEXUS_USER                       # env variable for username in deploy
          server-password: MAVEN_NEXUS_PASSWORD                   # env variable for token in deploy
          gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}   # Value of the GPG private key to import
          gpg-passphrase: MAVEN_GPG_PASSPHRASE
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        env:
          THIRDPARTY_READ_TOKEN: ${{ secrets.THIRDPARTY_READ_TOKEN }}

      - name: Maven Build (skip tests)
        if: ${{ !inputs.deploy_maven }}
        run: mvn -T 2 clean install -DskipTests ${{ inputs.maven_opts }} --no-transfer-progress
      - name: Maven Deploy (skip tests, deploy to Maven Central y GitHub Packages)
        if: ${{ inputs.deploy_maven }}
        run: mvn -T 2 clean deploy -DskipTests -Pdeploy-maven,deploy-github ${{ inputs.maven_opts }} --no-transfer-progress
        env:
          MAVEN_NEXUS_USER: ${{ secrets.MAVEN_USER_TOKEN }}
          MAVEN_NEXUS_PASSWORD: ${{ secrets.MAVEN_PASSWORD_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload build artifacts
        # This step uploads the build artifacts if requested by the caller.
        if: ${{ inputs.upload_artifact == true }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.build_folder }}
          path: build

      - name: Get project version
        id: get_project_version
        # This step extracts the Maven project version and exposes it as an output.
        run: |
          echo "version=$(mvn help:evaluate -q -Dexpression=project.version -DforceStdout)" >> "$GITHUB_OUTPUT"
      - name: Build summary
        # This step writes a small summary into the GitHub job summary, so it is
        # easy to inspect which dependencies_sha and cache key were used.
        shell: bash
        run: |
          {
            echo "## Java / Build summary"
            echo ""
            echo "- Build version: \`${{ steps.get_project_version.outputs.version}}\`"
            echo "- Hadoop flavour: \`${{ inputs.storage_hadoop }}\`"
            echo "- Repository: \`$GITHUB_REPOSITORY\`"
            echo "- Branch: \`$GITHUB_REF_NAME\`"
          } >> "$GITHUB_STEP_SUMMARY"
